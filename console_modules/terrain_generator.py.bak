"""
åœ°å½¢ç”Ÿæˆæ¨¡å— - å¯è§†åŒ–è°ƒç”¨ generate_terrain.py
"""
import dearpygui.dearpygui as dpg
from typing import Optional, List
from .base_module import ConsoleModule, ModuleRegistry


@ModuleRegistry.register
class TerrainGeneratorModule(ConsoleModule):
    """åœ°å½¢ç”Ÿæˆæ¨¡å—"""
    
    name = "terrain_generator"
    display_name = "ğŸ› ï¸ åœ°å½¢ç”Ÿæˆ"
    icon = "ğŸ› ï¸"
    description = "ç”Ÿæˆç¨‹åºåŒ–åœ°å½¢é«˜åº¦å›¾"
    
    def __init__(self, console_app: Any):
        super().__init__(console_app)
        self.is_generating = False
        
        # å‚æ•°
        self.width = 1024
        self.height = 1024
        self.seed = 12345
        self.noise_scale = 0.05
        self.octaves = 5
        self.persistence = 0.5
        self.lacunarity = 2.0
        self.height_scale = 20.0
        
        # è½¨é“å‚æ•°
        self.use_track = False
        self.track_csv = "scripts/track_example.csv"
        self.corridor_width = 120
        self.edge_falloff = 50
        
        # è¾“å‡º
        self.output_name = ""
        
        # UI å¼•ç”¨
        self.status_text = None
        self.progress_bar = None
        self.generate_button = None
    
    def build_ui(self, parent: Any) -> None:
        """æ„å»º UI"""
        with dpg.group(parent=parent, horizontal=False):
            # æ ‡é¢˜
            dpg.add_text("åœ°å½¢å‚æ•°é…ç½®", size=200)
            dpg.add_separator()
            
            # åŸºæœ¬å‚æ•°
            dpg.add_text("åŸºæœ¬å‚æ•°:")
            with dpg.group(horizontal=True):
                dpg.add_input_int(label="å®½åº¦ (px)", default_value=1024, width=120,
                                 callback=lambda s, a: setattr(self, 'width', a))
                dpg.add_input_int(label="é«˜åº¦ (px)", default_value=1024, width=120,
                                 callback=lambda s, a: setattr(self, 'height', a))
                dpg.add_input_int(label="ç§å­", default_value=12345, width=120,
                                 callback=lambda s, a: setattr(self, 'seed', a))
            
            dpg.add_spacer(height=10)
            
            # å™ªå£°å‚æ•°
            dpg.add_text("å™ªå£°å‚æ•°:")
            with dpg.group(horizontal=True):
                dpg.add_input_float(label="å™ªå£°ç¼©æ”¾", default_value=0.05, width=120,
                                   callback=lambda s, a: setattr(self, 'noise_scale', a))
                dpg.add_input_int(label="å…«åº¦éŸ³", default_value=5, min_value=1, max_value=10, width=120,
                                 callback=lambda s, a: setattr(self, 'octaves', a))
                dpg.add_input_float(label="æŒä¹…æ€§", default_value=0.5, min_value=0.1, max_value=1.0, width=120,
                                   callback=lambda s, a: setattr(self, 'persistence', a))
                dpg.add_input_float(label="Lacunarity", default_value=2.0, width=120,
                                   callback=lambda s, a: setattr(self, 'lacunarity', a))
            
            dpg.add_spacer(height=10)
            
            # é«˜åº¦å‚æ•°
            dpg.add_text("é«˜åº¦å‚æ•°:")
            with dpg.group(horizontal=True):
                dpg.add_input_float(label="é«˜åº¦ç¼©æ”¾", default_value=20.0, width=120,
                                   callback=lambda s, a: setattr(self, 'height_scale', a))
            
            dpg.add_spacer(height=15)
            
            # è½¨é“èµ°å»Šé€‰é¡¹
            dpg.add_text("è½¨é“èµ°å»Šï¼ˆå¯é€‰ï¼‰:")
            self.use_track_check = dpg.add_checkbox(
                label="å¯ç”¨è½¨é“åˆ·å¹³",
                default_value=False,
                callback=lambda s, a: setattr(self, 'use_track', a)
            )
            
            with dpg.group(enabled=False) as self.track_options_group:
                with dpg.group(horizontal=True):
                    self.track_csv_input = dpg.add_input_text(
                        label="CSV æ–‡ä»¶",
                        default_value="scripts/track_example.csv",
                        width=300,
                        callback=lambda s, a: setattr(self, 'track_csv', a)
                    )
                    dpg.add_button(label="æµè§ˆ", callback=self._browse_track_file)
                
                with dpg.group(horizontal=True):
                    dpg.add_input_int(label="èµ°å»Šå®½åº¦ (px)", default_value=120, width=120,
                                     callback=lambda s, a: setattr(self, 'corridor_width', a))
                    dpg.add_input_int(label="è¾¹ç¼˜è¡°å‡ (px)", default_value=50, width=120,
                                     callback=lambda s, a: setattr(self, 'edge_falloff', a))
            
            # ç›‘å¬ track check å˜åŒ–
            def on_track_toggle(sender, app_data):
                dpg.configure_item(self.track_options_group, enabled=app_data)
                self.use_track = app_data
            
            dpg.configure_item(self.use_track_check, callback=on_track_toggle)
            
            dpg.add_spacer(height=15)
            
            # è¾“å‡ºåç§°
            dpg.add_text("è¾“å‡ºæ–‡ä»¶å:")
            with dpg.group(horizontal=True):
                self.output_name_input = dpg.add_input_text(
                    label="",
                    default_value="generated_terrain",
                    width=250,
                    callback=lambda s, a: setattr(self, 'output_name', a)
                )
                dpg.add_text("ï¼ˆä¸åŒ…å«æ‰©å±•åï¼‰", color=(150, 150, 150, 255))
            
            dpg.add_spacer(height=20)
            
            # çŠ¶æ€å’Œè¿›åº¦
            dpg.add_text("çŠ¶æ€:", color=(200, 200, 200, 255))
            self.status_text = dpg.add_text("å°±ç»ª", color=(0, 255, 0, 255))
            
            self.progress_bar = dpg.add_progress_bar(default_value=0.0, width=-1)
            dpg.configure_item(self.progress_bar, show=False)
            
            dpg.add_spacer(height=15)
            
            # æ“ä½œæŒ‰é’®
            with dpg.group(horizontal=True):
                self.generate_button = dpg.add_button(
                    label="ğŸŒ ç”Ÿæˆåœ°å½¢",
                    width=150,
                    height=40,
                    callback=self._generate_terrain
                )
                dpg.add_button(
                    label="ğŸ“‚ æ‰“å¼€è¾“å‡ºç›®å½•",
                    width=150,
                    callback=self._open_output_dir
                )
                dpg.add_button(
                    label="ğŸ“„ æŸ¥çœ‹æ–‡æ¡£",
                    width=120,
                    callback=self._view_docs
                )
            
            dpg.add_spacer(height=15)
            
            # æ—¥å¿—è¾“å‡º
            dpg.add_separator()
            dpg.add_spacer(height=10)
            dpg.add_text("ç”Ÿæˆæ—¥å¿—:", color=(200, 200, 200, 255))
            with dpg.child_window(height=150, border=True, autosize_x=False):
                self.log_window = dpg.add_text("", wrap=600)
                self.log_messages: List[str] = []
    
    def _browse_track_file(self, sender=None, app_data=None) -> None:
        """æµè§ˆè½¨é“ CSV æ–‡ä»¶"""
        self.log("æ–‡ä»¶é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è·¯å¾„", "info")
    
    def _generate_terrain(self, sender=None, app_data=None) -> None:
        """ç”Ÿæˆåœ°å½¢"""
        if self.is_generating:
            self.log("åœ°å½¢å·²åœ¨ç”Ÿæˆä¸­", "warning")
            return
        
        if not self.output_name:
            self.log("è¯·è¾“å…¥è¾“å‡ºæ–‡ä»¶å", "error")
            return
        
        self.is_generating = True
        dpg.configure_item(self.generate_button, enabled=False)
        dpg.configure_item(self.progress_bar, show=True)
        dpg.configure_item(self.status_text, default_value="ç”Ÿæˆä¸­...", color=(255, 200, 0, 255))
        
        # æ„å»ºå‘½ä»¤
        cmd_parts = [
            "python", "scripts/generate_terrain.py",
            f"--width={self.width}",
            f"--height={self.height}",
            f"--seed={self.seed}",
            f"--name={self.output_name}",
            f"--noise-scale={self.noise_scale}",
            f"--octaves={self.octaves}",
            f"--persistence={self.persistence}",
            f"--lacunarity={self.lacunarity}",
            f"--height-scale={self.height_scale}",
        ]
        
        if self.use_track:
            cmd_parts.extend([
                f"--track-csv={self.track_csv}",
                f"--corridor-width-px={self.corridor_width}",
                f"--edge-falloff-px={self.edge_falloff}",
            ])
        
        command = " ".join(cmd_parts)
        self.log(f"æ‰§è¡Œå‘½ä»¤ï¼š{command}", "info")
        
        # æ‰§è¡Œå‘½ä»¤
        process_mgr = self.get_process_manager()
        if process_mgr:
            import asyncio
            
            def on_output(line: str):
                self.log(line, "info")
                # æ›´æ–°è¿›åº¦ï¼ˆç®€å•æ¨¡æ‹Ÿï¼‰
                if "DONE" in line or "Complete" in line:
                    dpg.configure_item(self.progress_bar, default_value=1.0)
            
            async def run():
                result = await process_mgr.run_command(
                    "terrain_gen",
                    command,
                    callback=on_output,
                    timeout=300.0  # 5 åˆ†é’Ÿè¶…æ—¶
                )
                
                if result.status.value == "completed":
                    dpg.configure_item(self.status_text, default_value="ç”ŸæˆæˆåŠŸ!", color=(0, 255, 0, 255))
                    self.log("åœ°å½¢ç”Ÿæˆå®Œæˆ!", "success")
                else:
                    dpg.configure_item(self.status_text, default_value=f"ç”Ÿæˆå¤±è´¥ï¼š{result.status.value}", color=(255, 0, 0, 255))
                    self.log(f"ç”Ÿæˆå¤±è´¥ï¼š{result.stderr}", "error")
                
                dpg.configure_item(self.progress_bar, show=False)
                dpg.configure_item(self.generate_button, enabled=True)
                self.is_generating = False
            
            if hasattr(self.console_app, 'run_async'):
                self.console_app.run_async(run())
            else:
                # ç®€å•åŒæ­¥æ‰§è¡Œ
                import subprocess
                try:
                    self.log("å¼€å§‹ç”Ÿæˆ...", "info")
                    proc = subprocess.Popen(
                        command,
                        shell=True,
                        stdout=subprocess.PIPE,
                        stderr=subprocess.STDOUT,
                        text=True
                    )
                    
                    for line in proc.stdout:
                        self.log(line.strip(), "info")
                    
                    proc.wait()
                    if proc.returncode == 0:
                        dpg.configure_item(self.status_text, default_value="ç”ŸæˆæˆåŠŸ!", color=(0, 255, 0, 255))
                        self.log("åœ°å½¢ç”Ÿæˆå®Œæˆ!", "success")
                    else:
                        dpg.configure_item(self.status_text, default_value="ç”Ÿæˆå¤±è´¥", color=(255, 0, 0, 255))
                        self.log("ç”Ÿæˆå¤±è´¥", "error")
                except Exception as e:
                    self.log(f"ç”Ÿæˆå¤±è´¥ï¼š{e}", "error")
                    dpg.configure_item(self.status_text, default_value=f"é”™è¯¯ï¼š{e}", color=(255, 0, 0, 255))
                finally:
                    dpg.configure_item(self.generate_button, enabled=True)
                    dpg.configure_item(self.progress_bar, show=False)
                    self.is_generating = False
        else:
            self.log("è¿›ç¨‹ç®¡ç†å™¨æœªåˆå§‹åŒ–", "error")
            self.is_generating = False
            dpg.configure_item(self.generate_button, enabled=True)
    
    def _open_output_dir(self, sender=None, app_data=None) -> None:
        """æ‰“å¼€è¾“å‡ºç›®å½•"""
        import subprocess
        output_dir = "res/terrain"
        import os
        if os.path.exists(output_dir):
            subprocess.run(["open", output_dir] if os.uname().sysname == "Darwin" else ["xdg-open", output_dir])
            self.log(f"æ‰“å¼€ç›®å½•ï¼š{output_dir}", "info")
        else:
            self.log(f"ç›®å½•ä¸å­˜åœ¨ï¼š{output_dir}", "warning")
    
    def _view_docs(self, sender=None, app_data=None) -> None:
        """æŸ¥çœ‹æ–‡æ¡£"""
        self.log("æŸ¥çœ‹ README.md ä¸­çš„åœ°å½¢ç”Ÿæˆæ–‡æ¡£", "info")
    
    def log(self, message: str, level: str = "info") -> None:
        """è®°å½•æ—¥å¿—åˆ° UI"""
        self.log_messages.append(f"[{level.upper()}] {message}")
        # ä¿æŒæœ€æ–° 50 æ¡
        if len(self.log_messages) > 50:
            self.log_messages = self.log_messages[-50:]
        
        if hasattr(self, 'log_window'):
            dpg.configure_item(self.log_window, default_value="\n".join(self.log_messages))
        
        # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°æ—¥å¿—
        super().log(message, level)
    
    def cleanup(self) -> None:
        """æ¸…ç†èµ„æº"""
        if self.is_generating:
            process_mgr = self.get_process_manager()
            if process_mgr:
                import asyncio
                async def cancel():
                    await process_mgr.kill_process("terrain_gen")
                if hasattr(self.console_app, 'run_async'):
                    self.console_app.run_async(cancel())
