"""
æ¸¸æˆå¯åŠ¨æ¨¡å— - æ”¯æŒå¤šè½¦è¾†é…ç½®
"""
import dearpygui.dearpygui as dpg
from typing import List, Dict, Any, Optional
from .base_module import ConsoleModule, ModuleRegistry


@ModuleRegistry.register
class GameLauncherModule(ConsoleModule):
    """æ¸¸æˆå¯åŠ¨æ¨¡å—"""
    
    name = "game_launcher"
    display_name = "ğŸš€ å¯åŠ¨æ¸¸æˆ"
    icon = "ğŸš€"
    description = "å¯åŠ¨è½¦è¾†æ¸¸æˆï¼Œæ”¯æŒå¤šè½¦è¾†é…ç½®"
    
    def __init__(self, console_app: Any):
        super().__init__(console_app)
        self.vehicle_configs: List[str] = []
        self.terrain_configs: List[str] = []
        self.selected_vehicle: Optional[str] = None
        self.selected_terrain: Optional[str] = None
        self.is_running: bool = False
        self.game_process_id: Optional[str] = None
        
        # UI ç»„ä»¶å¼•ç”¨
        self.vehicle_combo = None
        self.terrain_combo = None
        self.fullscreen_check = None
        self.debug_check = None
        self.status_text = None
    
    def build_ui(self, parent: Any) -> None:
        """æ„å»º UI"""
        with dpg.group(parent=parent, horizontal=False):
            # æ ‡é¢˜
            dpg.add_text("æ¸¸æˆå¯åŠ¨é…ç½®", size=200)
            dpg.add_separator()
            
            # è½¦è¾†é…ç½®é€‰æ‹©
            dpg.add_text("è½¦è¾†é…ç½®:")
            with dpg.group(horizontal=True):
                self.vehicle_combo = dpg.add_combo(
                    label="",
                    width=200,
                    callback=self._on_vehicle_selected
                )
                dpg.add_button(label="ğŸ”„ åˆ·æ–°", callback=self._refresh_configs)
                dpg.add_button(label="âœï¸ ç¼–è¾‘", callback=self._edit_vehicle_config)
            
            dpg.add_spacer(height=10)
            
            # åœ°å½¢é…ç½®é€‰æ‹©
            dpg.add_text("åœ°å½¢é…ç½®:")
            with dpg.group(horizontal=True):
                self.terrain_combo = dpg.add_combo(
                    label="",
                    width=200,
                    callback=self._on_terrain_selected
                )
                dpg.add_button(label="ğŸ”„ åˆ·æ–°", callback=self._refresh_configs)
                dpg.add_button(label="ğŸ› ï¸ ç”Ÿæˆ", callback=self._open_terrain_generator)
            
            dpg.add_spacer(height=15)
            
            # æ¸¸æˆè®¾ç½®
            dpg.add_text("æ¸¸æˆè®¾ç½®:")
            self.fullscreen_check = dpg.add_checkbox(label="å…¨å±æ¨¡å¼", default_value=False)
            self.debug_check = dpg.add_checkbox(label="è°ƒè¯•æ¨¡å¼", default_value=False)
            dpg.add_checkbox(label="å¯ç”¨é˜´å½±", default_value=True)
            
            dpg.add_spacer(height=15)
            
            # åˆ†è¾¨ç‡é€‰æ‹©
            with dpg.group(horizontal=True):
                dpg.add_text("åˆ†è¾¨ç‡:")
                resolution_combo = dpg.add_combo(
                    items=["1280x720", "1920x1080", "2560x1440", "3840x2160"],
                    default_value="1280x720",
                    width=150
                )
            
            dpg.add_spacer(height=20)
            
            # çŠ¶æ€æ˜¾ç¤º
            dpg.add_text("çŠ¶æ€:", color=(200, 200, 200, 255))
            self.status_text = dpg.add_text("å°±ç»ª", color=(0, 255, 0, 255))
            
            dpg.add_spacer(height=15)
            
            # æ“ä½œæŒ‰é’®
            with dpg.group(horizontal=True):
                self.start_button = dpg.add_button(
                    label="â–¶ï¸ å¯åŠ¨æ¸¸æˆ",
                    width=150,
                    height=40,
                    callback=self._start_game
                )
                dpg.add_button(
                    label="ğŸ›‘ åœæ­¢æ¸¸æˆ",
                    width=150,
                    height=40,
                    callback=self._stop_game,
                    enabled=False
                )
                dpg.add_button(
                    label="ğŸ“„ æŸ¥çœ‹æ—¥å¿—",
                    width=120,
                    callback=self._view_log
                )
            
            dpg.add_spacer(height=10)
            
            # è½¦è¾†ä¿¡æ¯é¢„è§ˆ
            dpg.add_separator()
            dpg.add_spacer(height=10)
            dpg.add_text("è½¦è¾†é¢„è§ˆ:", color=(200, 200, 200, 255))
            self.vehicle_info_text = dpg.add_text("è¯·é€‰æ‹©è½¦è¾†é…ç½®", color=(150, 150, 150, 255))
        
        # åˆå§‹åŠ è½½é…ç½®åˆ—è¡¨
        self._refresh_configs()
    
    def _refresh_configs(self, sender=None, app_data=None) -> None:
        """åˆ·æ–°é…ç½®åˆ—è¡¨"""
        config_mgr = self.get_config_manager()
        if not config_mgr:
            self.log("é…ç½®ç®¡ç†å™¨æœªåˆå§‹åŒ–", "error")
            return
        
        # åŠ è½½è½¦è¾†é…ç½®
        self.vehicle_configs = config_mgr.list_configs("vehicles")
        if self.vehicle_combo:
            dpg.configure_item(self.vehicle_combo, items=self.vehicle_configs)
            if self.vehicle_configs and not self.selected_vehicle:
                self.selected_vehicle = self.vehicle_configs[0]
                dpg.configure_item(self.vehicle_combo, default_value=self.selected_vehicle)
                self._update_vehicle_info()
        
        # åŠ è½½åœ°å½¢é…ç½®
        self.terrain_configs = config_mgr.list_configs("terrain")
        if self.terrain_combo:
            dpg.configure_item(self.terrain_combo, items=self.terrain_configs)
            if self.terrain_configs and not self.selected_terrain:
                self.selected_terrain = self.terrain_configs[0]
                dpg.configure_item(self.terrain_combo, default_value=self.selected_terrain)
        
        self.log(f"å·²åŠ è½½ {len(self.vehicle_configs)} ä¸ªè½¦è¾†é…ç½®ï¼Œ{len(self.terrain_configs)} ä¸ªåœ°å½¢é…ç½®", "info")
    
    def _on_vehicle_selected(self, sender, app_data) -> None:
        """è½¦è¾†é…ç½®é€‰æ‹©å˜æ›´"""
        self.selected_vehicle = app_data
        self._update_vehicle_info()
    
    def _on_terrain_selected(self, sender, app_data) -> None:
        """åœ°å½¢é…ç½®é€‰æ‹©å˜æ›´"""
        self.selected_terrain = app_data
    
    def _update_vehicle_info(self) -> None:
        """æ›´æ–°è½¦è¾†ä¿¡æ¯é¢„è§ˆ"""
        if not self.selected_vehicle:
            return
        
        config_mgr = self.get_config_manager()
        if not config_mgr:
            return
        
        try:
            config = config_mgr.load_config("vehicles", self.selected_vehicle)
            name = config.get("name", self.selected_vehicle)
            mass = config.get("vehicle_mass", config.get("physics", {}).get("mass", "N/A"))
            max_speed = config.get("physics", {}).get("max_speed", "N/A")
            
            info = f"{name} | è´¨é‡ï¼š{mass}kg | æœ€é«˜é€Ÿåº¦ï¼š{max_speed}km/h"
            if self.vehicle_info_text:
                dpg.configure_item(self.vehicle_info_text, default_value=info)
        except Exception as e:
            if self.vehicle_info_text:
                dpg.configure_item(self.vehicle_info_text, default_value=f"åŠ è½½å¤±è´¥ï¼š{e}")
    
    def _start_game(self, sender=None, app_data=None) -> None:
        """å¯åŠ¨æ¸¸æˆ"""
        if self.is_running:
            self.log("æ¸¸æˆå·²åœ¨è¿è¡Œä¸­", "warning")
            return
        
        if not self.selected_vehicle:
            self.log("è¯·é€‰æ‹©è½¦è¾†é…ç½®", "error")
            return
        
        # æ„å»ºå¯åŠ¨å‘½ä»¤
        import sys
        cmd_parts = [sys.executable, "main.py"]
        
        # æ·»åŠ è½¦è¾†é…ç½®å‚æ•°
        if self.selected_vehicle:
            cmd_parts.extend(["--vehicle", self.selected_vehicle])
        
        # æ·»åŠ åœ°å½¢é…ç½®å‚æ•°ï¼ˆå¦‚æœå®ç°ï¼‰
        if self.selected_terrain:
            cmd_parts.extend(["--terrain", self.selected_terrain])
        
        # æ·»åŠ å…¶ä»–é€‰é¡¹
        if self.debug_check and dpg.get_value(self.debug_check):
            cmd_parts.append("--debug")
        
        command = " ".join(cmd_parts)
        self.game_process_id = "game_session"
        
        self.log(f"å¯åŠ¨æ¸¸æˆï¼š{command}", "info")
        dpg.configure_item(self.status_text, default_value="å¯åŠ¨ä¸­...", color=(255, 200, 0, 255))
        
        # å¼‚æ­¥å¯åŠ¨æ¸¸æˆè¿›ç¨‹
        process_mgr = self.get_process_manager()
        if process_mgr:
            import asyncio
            
            def on_output(line: str):
                self.log(f"[æ¸¸æˆ] {line}", "info")
            
            async def start():
                result = await process_mgr.run_command(
                    self.game_process_id,
                    command,
                    callback=on_output,
                    cwd=None  # ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•
                )
                
                if result.status.value == "completed":
                    self.log("æ¸¸æˆå·²é€€å‡º", "info")
                    dpg.configure_item(self.status_text, default_value="å·²é€€å‡º", color=(150, 150, 150, 255))
                else:
                    self.log(f"æ¸¸æˆå¼‚å¸¸é€€å‡ºï¼š{result.stderr}", "error")
                    dpg.configure_item(self.status_text, default_value=f"é”™è¯¯ï¼š{result.status.value}", color=(255, 0, 0, 255))
                
                self.is_running = False
                if self.start_button:
                    dpg.configure_item(self.start_button, enabled=True)
                # æŸ¥æ‰¾åœæ­¢æŒ‰é’®å¹¶ç¦ç”¨
                for item in dpg.get_item_children(self.build_ui.__code__.co_consts[0] if hasattr(self.build_ui, '__code__') else 0):
                    if dpg.get_item_label(item) == "ğŸ›‘ åœæ­¢æ¸¸æˆ":
                        dpg.configure_item(item, enabled=False)
                        break
            
            # å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
            if hasattr(self.console_app, 'run_async'):
                self.console_app.run_async(start())
            else:
                # ç®€å•æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ subprocessï¼ˆé˜»å¡ï¼‰
                import subprocess
                try:
                    self.process = subprocess.Popen(command, shell=True)
                    self.is_running = True
                    dpg.configure_item(self.start_button, enabled=False)
                    # æŸ¥æ‰¾åœæ­¢æŒ‰é’®å¹¶å¯ç”¨
                    dpg.configure_item(self._stop_button, enabled=True)
                    dpg.configure_item(self.status_text, default_value="è¿è¡Œä¸­", color=(0, 255, 0, 255))
                    self.log("æ¸¸æˆå·²å¯åŠ¨", "success")
                except Exception as e:
                    self.log(f"å¯åŠ¨å¤±è´¥ï¼š{e}", "error")
                    dpg.configure_item(self.status_text, default_value=f"å¯åŠ¨å¤±è´¥ï¼š{e}", color=(255, 0, 0, 255))
    
    def _stop_game(self, sender=None, app_data=None) -> None:
        """åœæ­¢æ¸¸æˆ"""
        if not self.is_running:
            self.log("æ¸¸æˆæœªè¿è¡Œ", "warning")
            return
        
        process_mgr = self.get_process_manager()
        if process_mgr and self.game_process_id:
            import asyncio
            async def stop():
                await process_mgr.kill_process(self.game_process_id)
            
            if hasattr(self.console_app, 'run_async'):
                self.console_app.run_async(stop())
        
        # ç®€å•æ–¹æ¡ˆ
        if hasattr(self, 'process') and self.process:
            self.process.terminate()
            self.log("æ¸¸æˆå·²åœæ­¢", "info")
            self.is_running = False
            dpg.configure_item(self.start_button, enabled=True)
            dpg.configure_item(self._stop_button, enabled=False)
            dpg.configure_item(self.status_text, default_value="å·²åœæ­¢", color=(150, 150, 150, 255))
    
    def _edit_vehicle_config(self, sender=None, app_data=None) -> None:
        """ç¼–è¾‘è½¦è¾†é…ç½®"""
        if not self.selected_vehicle:
            self.log("è¯·å…ˆé€‰æ‹©è½¦è¾†é…ç½®", "warning")
            return
        
        self.log(f"ç¼–è¾‘é…ç½®ï¼š{self.selected_vehicle}ï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰", "info")
        # TODO: æ‰“å¼€é…ç½®ç¼–è¾‘å™¨
    
    def _open_terrain_generator(self, sender=None, app_data=None) -> None:
        """æ‰“å¼€åœ°å½¢ç”Ÿæˆå™¨"""
        self.log("åˆ‡æ¢åˆ°åœ°å½¢ç”Ÿæˆå™¨", "info")
        if hasattr(self.console_app, 'switch_module'):
            self.console_app.switch_module("terrain_generator")
    
    def _view_log(self, sender=None, app_data=None) -> None:
        """æŸ¥çœ‹æ¸¸æˆæ—¥å¿—"""
        import os
        log_path = "game.log"
        if os.path.exists(log_path):
            self.log(f"æ—¥å¿—æ–‡ä»¶ï¼š{log_path}", "info")
            # TODO: æ‰“å¼€æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹å™¨
            import subprocess
            subprocess.run(["open", log_path] if os.uname().sysname == "Darwin" else ["xdg-open", log_path])
        else:
            self.log("æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨", "warning")
    
    def on_show(self) -> None:
        """æ¨¡å—æ˜¾ç¤ºæ—¶"""
        self._refresh_configs()
    
    def cleanup(self) -> None:
        """æ¸…ç†èµ„æº"""
        if self.is_running and hasattr(self, 'process'):
            self.process.terminate()
